
package org.cytoscape.diffusion.internal;

import org.cytoscape.diffusion.internal.NodeTable;

import java.awt.Component;
import java.awt.GridLayout;
import java.awt.event.ActionListener;
import java.awt.event.ActionEvent;

import javax.swing.JPanel;
import javax.swing.JLabel;
import javax.swing.JTextField;
import javax.swing.JComboBox;
import javax.swing.Icon;
import javax.swing.DefaultComboBoxModel;
import javax.swing.event.PopupMenuEvent;
import javax.swing.event.PopupMenuListener;

import org.cytoscape.application.CyApplicationManager;
import org.cytoscape.application.swing.CytoPanelComponent;
import org.cytoscape.application.swing.CytoPanelName;

public class OutputPanel extends JPanel implements CytoPanelComponent {

  private JLabel columnNameLabel = new JLabel("Column Name: ");
  private JComboBox columnNameComboBox;

  private JLabel thresholdValueLabel = new JLabel("Theshold Value: ");
  private JTextField thresholdValueField = new JTextField("1.0");

  private NodeTable nodeTable;

  public OutputPanel(CyApplicationManager applicationManager) {
    //Set listener on fields
    this.nodeTable = new NodeTable(applicationManager.getCurrentNetwork().getDefaultNodeTable());
    columnNameComboBox = new JComboBox(this.nodeTable.getAvaiableOutputColumns());
    ActionListener listener = this.getSelectNodesListener();
    PopupMenuListener menuListener = this.getMenuListener();
    thresholdValueField.addActionListener(listener);
    columnNameComboBox.addActionListener(listener);
    columnNameComboBox.addPopupMenuListener(menuListener);

    //Add fields and labels to GUI panel
    this.setLayout(new GridLayout(12, 1));
    this.add(columnNameLabel);
    this.add(columnNameComboBox);
    this.add(thresholdValueLabel);
    this.add(thresholdValueField);
  }

  private MenuListener getMenuListener() {
    return new MenuListener(this);
  }

  private ActionListener getSelectNodesListener() {
    return new SelectionListener(this);
  }

  public class MenuListener implements PopupMenuListener {

      OutputPanel panel;

      public void popupMenuCanceled(PopupMenuEvent e) {
      }

      public void popupMenuWillBecomeInvisible(PopupMenuEvent e) {
      }


      public MenuListener(OutputPanel panel) {
        this.panel = panel;
      }

      public void popupMenuWillBecomeVisible(PopupMenuEvent e) {
        this.panel.refreshOutputColumns();
      }
    };

  public class SelectionListener implements ActionListener {

    OutputPanel panel;

    public SelectionListener(OutputPanel panel) {
      this.panel = panel;
    }

    public void actionPerformed(ActionEvent e) {
      Double threshold = 0.0;
      String columnName = this.panel.getOutputColumn();
      if (e.getActionCommand() == "comboBoxChanged") {
        threshold = this.panel.nodeTable.getThreshold(columnName, 90);
      } else {
        threshold = this.panel.getThreshold();
      }
      this.panel.setThreshold(threshold);
      this.panel.nodeTable.selectNodesOverThreshold(columnName, threshold);
    }

  }

  public void refreshOutputColumns() {
    this.columnNameComboBox.setModel(new DefaultComboBoxModel(this.nodeTable.getAvaiableOutputColumns()));
  }

  public CytoPanelName getCytoPanelName() {
    return CytoPanelName.EAST;
  }

  public String getOutputColumn() {
    return (String)this.columnNameComboBox.getSelectedItem();
  }

  public void setOutputColumn(String columnName) {
    this.columnNameComboBox.addItem(columnName);
    this.columnNameComboBox.setSelectedItem(columnName);
  }

  public Double getThreshold() {
    return Double.parseDouble(this.thresholdValueField.getText());
  }

  public void setThreshold(Double threshold) {
    this.thresholdValueField.setText(threshold.toString());
  }

  public Component getComponent() {
		return this;
	}

  public String getTitle() {
		return "Diffusion Output";
	}

  public Icon getIcon() {
    return null;
  }


}
